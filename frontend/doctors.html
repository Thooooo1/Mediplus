<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Danh sách bác sĩ — MediBook</title>
    <meta name="description" content="Tìm và đặt lịch khám với bác sĩ chuyên khoa tại MediBook"/>
    <link rel="stylesheet" href="app_v2.css"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    <style>
        .page-header { background: linear-gradient(135deg, #1e3a8a, #2563eb); color: white; padding: 48px 0; }
        .page-header h1 { font-size: 32px; margin-bottom: 8px; }
        .page-header p { opacity: 0.85; font-size: 16px; }
        .filter-bar { background: white; border-radius: var(--radius-xl); padding: 20px 24px; box-shadow: var(--shadow-md); margin-top: -32px; position: relative; z-index: 10; display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { flex: 1; min-width: 180px; }
        .filter-group label { display: block; font-size: 12px; font-weight: 600; color: var(--neutral-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .doctor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; margin-top: 32px; }
        .doctor-card { background: white; border-radius: var(--radius-lg); border: 1px solid var(--neutral-200); overflow: hidden; transition: border-color 0.2s, box-shadow 0.2s; cursor: pointer; }
        .doctor-card:hover { border-color: var(--primary); box-shadow: var(--shadow-md); transform: none; }
        .doctor-card-body { padding: 24px; }
        .doctor-card-top { display: flex; gap: 16px; align-items: flex-start; }
        .doctor-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--neutral-100); display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; border: 1px solid var(--neutral-200); }
        .doctor-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .doctor-avatar .material-icons-round { font-size: 40px; color: var(--neutral-400); }
        .doctor-info h3 { font-size: 16px; margin-bottom: 2px; color: var(--primary-dark); }
        .doctor-info .specialty { font-size: 13px; color: var(--neutral-600); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .doctor-info .clinic { font-size: 13px; color: var(--neutral-500); margin-top: 4px; }
        .doctor-meta { display: flex; gap: 16px; margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--neutral-200); font-size: 13px; color: var(--neutral-600); }
        .doctor-meta span { display: flex; align-items: center; gap: 4px; }
        .doctor-meta .material-icons-round { font-size: 16px; color: var(--primary); }
        .doctor-card-footer { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: white; border-top: 1px solid var(--neutral-100); }
        .btn-book { padding: 10px 20px; background: var(--warning); color: white; border: none; border-radius: var(--radius-md); font-weight: 700; font-size: 14px; cursor: pointer; transition: background 0.2s; }
        .btn-book:hover { background: #d97706; }
        .no-results { text-align: center; padding: 60px 24px; color: var(--neutral-500); }
        @media (max-width: 768px) {
            .doctor-grid { grid-template-columns: 1fr; }
            .filter-bar { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="nav" id="nav">
        <div style="flex:1"><a href="index.html"><b>MediBook</b></a></div>
        <div style="display:flex;gap:12px;align-items:center">
            <a href="doctors.html" style="font-weight:600;color:var(--primary)">Bác sĩ</a>
            <a href="login.html" class="btn-primary btn-sm">Đăng nhập</a>
        </div>
    </div>

    <div class="page-header">
        <div class="container">
            <h1>Tìm bác sĩ phù hợp</h1>
            <p>Lọc theo chuyên khoa, tìm kiếm theo tên và đặt lịch ngay hôm nay.</p>
        </div>
    </div>

    <div class="container">
        <div class="filter-bar">
            <div class="filter-group">
                <label>Chuyên khoa</label>
                <select id="specialtyFilter" class="form-input">
                    <option value="">Tất cả chuyên khoa</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Tìm kiếm</label>
                <input type="text" id="searchInput" class="form-input" placeholder="Nhập tên bác sĩ..."/>
            </div>
            <button class="btn-primary" onclick="loadDoctors()" style="height:42px">
                <span class="material-icons-round" style="font-size:18px">search</span>
                Tìm
            </button>
        </div>

        <div id="doctorGrid" class="doctor-grid"></div>
        <div id="pagination" class="pagination"></div>
    </div>

    <script src="app_v2.js"></script>
    <script>
        let currentPage = 0;
        const PAGE_SIZE = 9;

        function getAvatarHtml(d) {
            if (d.avatarUrl) {
                return `<img src="${d.avatarUrl}" alt="${d.fullName}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(d.fullName)}&background=eff6ff&color=2563eb'">`;
            }
            return '<span class="material-icons-round">person</span>';
        }

        (async () => {
            // Handle query params from index.html
            const params = new URLSearchParams(window.location.search);
            const qParam = params.get('q');
            const specParam = params.get('specialty');
            const typeParam = params.get('type');
            
            if (qParam) document.getElementById('searchInput').value = qParam;

            if (typeParam === 'telemedicine') {
                document.querySelector('.page-header h1').textContent = 'Tư vấn trực tuyến với Bác sĩ';
                document.querySelector('.page-header p').textContent = 'Chọn bác sĩ và đặt khung giờ tư vấn Video Call ngay tại nhà.';
            }

            // Load specialties
            try {
                const r = await API('/api/specialties');
                if (r.ok) {
                    const specs = await r.json();
                    const sel = document.getElementById('specialtyFilter');
                    specs.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name;
                        if (specParam && specParam === s.id.toString()) opt.selected = true;
                        sel.appendChild(opt);
                    });
                }
            } catch(e) {}

            loadDoctors();
        })();

        async function loadDoctors() {
            const grid = document.getElementById('doctorGrid');
            showSkeleton(grid, 6);

            const specId = document.getElementById('specialtyFilter').value;
            const q = document.getElementById('searchInput').value.trim();

            let url = `/api/doctors?page=${currentPage}&size=${PAGE_SIZE}`;
            if (specId) url += `&specialtyId=${specId}`;
            if (q) url += `&q=${encodeURIComponent(q)}`;

            try {
                const r = await API(url);
                if (!r.ok) throw new Error('Lỗi tải danh sách bác sĩ');
                const data = await r.json();

                if (!data.content || data.content.length === 0) {
                    showEmptyState(grid, 'person_search', 'Không tìm thấy bác sĩ', 'Thử thay đổi bộ lọc hoặc từ khóa tìm kiếm.');
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }

                grid.innerHTML = data.content.map(d => `
                    <div class="doctor-card" onclick="location.href='doctor-details.html?id=${d.id}'">
                        <div class="doctor-card-body">
                            <div class="doctor-card-top">
                                <div class="doctor-avatar">
                                    ${getAvatarHtml(d)}
                                </div>
                                <div class="doctor-info">
                                    <h3>${d.title ? d.title + ' ' : ''}${d.fullName}</h3>
                                    <div class="specialty">${d.specialtyName}</div>
                                    ${d.clinicName ? `<div class="clinic">${d.clinicName}</div>` : ''}
                                </div>
                            </div>
                            <div class="doctor-meta">
                                ${d.yearsExperience ? `<span><span class="material-icons-round">work</span>${d.yearsExperience} năm</span>` : ''}
                                ${d.rating ? `<span><span class="material-icons-round" style="color:var(--warning)">star</span>${d.rating.toFixed(1)} (${d.ratingCount || 0})</span>` : ''}
                                ${d.country ? `<span><span class="material-icons-round">location_on</span>${d.country}</span>` : ''}
                            </div>
                        </div>
                        <div class="doctor-card-footer">
                            <div style="font-size:13px; color:var(--neutral-500)">
                                Giá khám:<br>
                                <span style="font-size:16px; font-weight:700; color:var(--neutral-900)">
                                    ${d.consultFeeVnd ? new Intl.NumberFormat('vi-VN').format(d.consultFeeVnd) + 'đ' : 'Liên hệ'}
                                </span>
                            </div>
                            <button class="btn-book">Đặt khám ngay</button>
                        </div>
                    </div>
                `).join('');

                // Pagination
                renderDocPagination(data.totalPages, data.number);
            } catch (err) {
                showErrorState(grid, err.message, loadDoctors);
            }
        }

        function renderDocPagination(totalPages, current) {
            const pag = document.getElementById('pagination');
            if (totalPages <= 1) { pag.innerHTML = ''; return; }
            let html = `<button ${current === 0 ? 'disabled' : ''} onclick="goPage(${current - 1})">‹</button>`;
            for (let i = 0; i < totalPages; i++) {
                html += `<button class="${i === current ? 'active' : ''}" onclick="goPage(${i})">${i + 1}</button>`;
            }
            html += `<button ${current >= totalPages - 1 ? 'disabled' : ''} onclick="goPage(${current + 1})">›</button>`;
            pag.innerHTML = html;
        }

        function goPage(p) { currentPage = p; loadDoctors(); window.scrollTo({ top: 200, behavior: 'smooth' }); }

        // Filter on Enter
        document.getElementById('searchInput').addEventListener('keydown', e => { if (e.key === 'Enter') { currentPage = 0; loadDoctors(); } });
        document.getElementById('specialtyFilter').addEventListener('change', () => { currentPage = 0; loadDoctors(); });
    </script>
</body>
</html>
