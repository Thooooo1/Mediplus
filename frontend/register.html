<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Đăng ký — MediBook</title>
    <meta name="description" content="Đăng ký tài khoản MediBook miễn phí để đặt lịch khám bệnh"/>
    <link rel="stylesheet" href="app_v2.css"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    <style>
        .auth-page { min-height: 100vh; display: flex; }
        .auth-left {
            flex: 1; background: linear-gradient(135deg, #1e40af 0%, #2563eb 50%, #3b82f6 100%);
            display: flex; align-items: center; justify-content: center; padding: 48px;
            position: relative; overflow: hidden;
        }
        .auth-left::before {
            content: ''; position: absolute; inset: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .auth-hero { position: relative; z-index: 1; color: white; max-width: 480px; }
        .auth-hero h1 { font-size: 42px; font-weight: 800; margin-bottom: 16px; line-height: 1.2; }
        .auth-hero p { font-size: 18px; opacity: 0.9; line-height: 1.7; }
        .auth-right {
            flex: 1; display: flex; align-items: center; justify-content: center; padding: 48px;
            background: var(--neutral-50);
        }
        .auth-form-container { width: 100%; max-width: 420px; }
        .auth-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 32px; }
        .auth-logo .material-icons-round { font-size: 36px; color: var(--primary); }
        .auth-logo span { font-size: 24px; font-weight: 800; color: var(--neutral-900); }
        .auth-form-container h2 { font-size: 28px; margin-bottom: 8px; }
        .auth-form-container .subtitle { color: var(--neutral-500); margin-bottom: 32px; font-size: 15px; }
        .auth-links { text-align: center; margin-top: 24px; font-size: 14px; color: var(--neutral-500); }
        .auth-links a { color: var(--primary); font-weight: 600; }
        .pw-strength { height: 4px; background: var(--neutral-200); border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .pw-strength-bar { height: 100%; width: 0; border-radius: 2px; transition: all 0.3s; }
        @media (max-width: 900px) {
            .auth-left { display: none; }
            .auth-right { padding: 24px; }
        }
    </style>
</head>
<body>
    <div class="auth-page">
        <div class="auth-left">
            <div class="auth-hero">
                <h1>Bắt đầu hành trình chăm sóc sức khỏe</h1>
                <p>Tạo tài khoản MediBook miễn phí để đặt lịch khám với hàng trăm bác sĩ chuyên khoa hàng đầu.</p>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <div class="auth-logo">
                    <span class="material-icons-round">medical_services</span>
                    <span>MediBook</span>
                </div>
                <h2>Tạo tài khoản</h2>
                <p class="subtitle">Chỉ mất vài giây để bắt đầu.</p>

                <div id="error-msg" style="display:none;background:var(--danger-light);color:var(--danger);padding:12px 16px;border-radius:var(--radius-lg);font-size:14px;margin-bottom:16px;"></div>

                <form id="regForm" autocomplete="on">
                    <div class="form-group">
                        <label class="form-label">Họ và tên</label>
                        <input type="text" id="fullName" class="form-input" placeholder="Nguyễn Văn A" required autocomplete="name"/>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="email" class="form-input" placeholder="you@example.com" required autocomplete="email"/>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Số điện thoại <span style="color:var(--neutral-400)">(tùy chọn)</span></label>
                        <input type="tel" id="phone" class="form-input" placeholder="0912 345 678" autocomplete="tel"/>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mật khẩu</label>
                        <input type="password" id="password" class="form-input" placeholder="Tối thiểu 8 ký tự, có chữ + số" required autocomplete="new-password" minlength="8"/>
                        <div class="pw-strength"><div class="pw-strength-bar" id="pwBar"></div></div>
                        <p class="form-hint" id="pwHint">Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ cái và số.</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Xác nhận mật khẩu</label>
                        <input type="password" id="password2" class="form-input" placeholder="Nhập lại mật khẩu" required autocomplete="new-password"/>
                    </div>
                    <button type="submit" class="btn-primary btn-lg" style="width:100%;margin-top:8px" id="regBtn">
                        <span class="material-icons-round" style="font-size:20px">person_add</span>
                        Đăng ký
                    </button>
                </form>

                <p class="auth-links">
                    Đã có tài khoản? <a href="login.html">Đăng nhập</a>
                </p>
            </div>
        </div>
    </div>

    <script src="app_v2.js"></script>
    <script>
        // Password strength indicator
        document.getElementById('password').addEventListener('input', (e) => {
            const pw = e.target.value;
            const bar = document.getElementById('pwBar');
            let score = 0;
            if (pw.length >= 8) score++;
            if (/[A-Za-z]/.test(pw)) score++;
            if (/\d/.test(pw)) score++;
            if (/[^A-Za-z0-9]/.test(pw)) score++;

            const colors = ['var(--danger)', 'var(--warning)', 'var(--warning)', 'var(--success)'];
            const widths = ['25%', '50%', '75%', '100%'];
            bar.style.width = score > 0 ? widths[score - 1] : '0';
            bar.style.background = score > 0 ? colors[score - 1] : 'transparent';
        });

        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('regBtn');
            const errDiv = document.getElementById('error-msg');
            errDiv.style.display = 'none';

            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim() || null;
            const password = document.getElementById('password').value;
            const password2 = document.getElementById('password2').value;

            // Validation
            if (fullName.length < 2) { errDiv.textContent = 'Họ tên phải có ít nhất 2 ký tự.'; errDiv.style.display = 'block'; return; }
            if (!/^(?=.*[A-Za-z])(?=.*\d).{8,}$/.test(password)) {
                errDiv.textContent = 'Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ cái và số.';
                errDiv.style.display = 'block'; return;
            }
            if (password !== password2) { errDiv.textContent = 'Mật khẩu xác nhận không khớp.'; errDiv.style.display = 'block'; return; }

            btn.disabled = true;
            btn.innerHTML = '<span class="loader-spinner" style="width:20px;height:20px;border-width:2px"></span> Đang xử lý...';

            try {
                const r = await API('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ email, fullName, password, phone })
                });

                if (!r.ok) {
                    const data = await r.json().catch(() => ({}));
                    throw new Error(data.error || data.errors?.email || 'Đăng ký thất bại. Vui lòng thử lại.');
                }

                const data = await r.json();
                localStorage.setItem('token', data.token);
                localStorage.setItem('role', data.role);

                showToast('Đăng ký thành công! Chào mừng bạn đến với MediBook.', 'success');
                setTimeout(() => { location.href = 'index.html'; }, 800);
            } catch (err) {
                errDiv.textContent = err.message;
                errDiv.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons-round" style="font-size:20px">person_add</span> Đăng ký';
            }
        };
    </script>
</body>
</html>
