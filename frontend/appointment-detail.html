<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chi tiết lịch hẹn — MediBook</title>
    <link rel="stylesheet" href="app_v2.css"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    <style>
        .page-header { background: var(--neutral-50); border-bottom: 1px solid var(--neutral-100); padding: 32px 0; margin-bottom: 40px; }
        .detail-grid { display: grid; grid-template-columns: 1fr 350px; gap: 32px; }
        
        .info-section { background: white; border-radius: var(--radius-xl); border: 1px solid var(--neutral-100); padding: 32px; margin-bottom: 24px; }
        .info-title { font-size: 14px; font-weight: 800; color: var(--neutral-400); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        
        .profile-card { text-align: center; background: var(--neutral-50); border-radius: var(--radius-2xl); padding: 32px; border: 1px solid var(--neutral-100); }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; display: block; margin: 0 auto 20px; box-shadow: 0 8px 24px rgba(0, 113, 186, 0.12); background: white; padding: 4px; border: 1px solid var(--neutral-100); }
        
        .appt-meta-box { background: var(--primary-light); border-radius: var(--radius-xl); padding: 24px; display: flex; align-items: center; gap: 20px; margin-bottom: 32px; }
        .appt-meta-icon { width: 56px; height: 56px; border-radius: var(--radius-lg); background: white; display: flex; align-items: center; justify-content: center; color: var(--primary); box-shadow: var(--shadow-sm); }
        
        .label-value-group { margin-bottom: 20px; }
        .label-value-group .label { font-size: 12px; color: var(--neutral-500); margin-bottom: 4px; font-weight: 600; }
        .label-value-group .value { font-size: 15px; color: var(--neutral-800); font-weight: 700; }

        @media (max-width: 992px) {
            .detail-grid { grid-template-columns: 1fr; }
            .side-panel { order: -1; }
        }

        /* PRINT STYLES */
        @media print {
            body { background: white !important; font-size: 12pt; }
            .nav, footer, .page-header nav, #actionButtons, .btn-ghost, .material-icons-round.spinner, #statusBadge { display: none !important; }
            .page-header { background: white !important; border: none !important; padding: 0 0 20px 0 !important; margin-bottom: 20px !important; }
            .page-header h1 { font-size: 24pt !important; text-align: center; }
            .detail-grid { grid-template-columns: 1fr !important; gap: 0 !important; }
            .info-section { border: 1px solid #eee !important; box-shadow: none !important; margin-bottom: 15px !important; padding: 20px !important; }
            .appt-meta-box { background: #f8f9fa !important; color: black !important; border: 1px solid #eee !important; }
            .appt-meta-icon { border: 1px solid #ddd !important; }
            .container { max-width: 100% !important; width: 100% !important; padding: 0 !important; }
            .main-content { margin: 0 !important; padding: 0 !important; }
            .profile-card { background: white !important; border: 1px solid #eee !important; margin-top: 20px; }
            
            .print-only { display: block !important; }
            .no-print { display: none !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div class="nav" id="nav"><div style="flex:1"><a href="index.html"><b>MediBook</b></a></div></div>

    <div id="loadingState" style="padding: 100px 0;">
        <div class="container text-center">
            <span class="material-icons-round spinner text-primary" style="font-size:48px">autorenew</span>
            <p class="mt-3 text-neutral-500">Đang tải chi tiết lịch hẹn...</p>
        </div>
    </div>

    <div id="mainContent" style="display:none">
        <header class="page-header">
            <div class="container d-flex align-items-center justify-content-between">
                <div>
                    <nav class="mb-2">
                        <a href="index.html" class="text-neutral-500" style="text-decoration:none; font-size:13px">Trang chủ</a>
                        <span class="material-icons-round text-neutral-300 mx-1" style="font-size:14px">chevron_right</span>
                        <a id="breadcrumbParent" href="my-appointments.html" class="text-neutral-500" style="text-decoration:none; font-size:13px">Lịch hẹn</a>
                    </nav>
                    <h1 class="h2 mb-0" id="pageTitle">Chi tiết lịch hẹn</h1>
                </div>
                <div id="statusBadgeContainer"></div>
            </div>
        </header>

        <div class="container" style="padding-bottom:100px;">
            <div class="detail-grid">
                <div class="main-panel">
                    <!-- Date/Time Highlight -->
                    <div class="appt-meta-box">
                        <div class="appt-meta-icon">
                            <span class="material-icons-round" style="font-size:32px">event_available</span>
                        </div>
                        <div style="flex:1">
                            <div class="text-primary font-bold uppercase" style="font-size:11px; letter-spacing:0.1em">Thời gian khám bệnh</div>
                            <div class="h3 mb-0 text-primary" id="apptTimeFull">—</div>
                        </div>
                        <div class="text-end">
                            <div class="text-neutral-400 font-bold uppercase" style="font-size:11px; letter-spacing:0.1em">Mã lịch hẹn</div>
                            <div class="font-bold text-neutral-800" id="apptIdDisplay">#—</div>
                        </div>
                    </div>

                    <!-- Medical Details -->
                    <div class="info-section">
                        <h4 class="info-title"><span class="material-icons-round">medical_information</span> Nội dung khám</h4>
                        <div class="row g-4">
                            <div class="col-md-12">
                                <div class="label-value-group">
                                    <div class="label">Lý do khám / Triệu chứng</div>
                                    <div class="value p-3 bg-neutral-50 rounded-xl border border-neutral-100 italic" id="apptNote">Không có ghi chú.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="label-value-group">
                                    <div class="label">Chuyên khoa</div>
                                    <div class="value" id="apptSpec">—</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="label-value-group">
                                    <div class="label">Phòng khám / Địa chỉ</div>
                                    <div class="value" id="apptClinic">—</div>
                                </div>
                            </div>
                            <div class="col-md-12 print-only">
                                <div style="margin-top:40px; display:flex; justify-content:space-between; text-align:center">
                                    <div style="width:200px">
                                        <div style="font-size:12px; margin-bottom:60px">Xác nhận của Bệnh viện</div>
                                        <div style="border-top:1px dashed #ccc; padding-top:8px; font-size:11px; color:#666">(Ký và đóng dấu)</div>
                                    </div>
                                    <div style="width:200px">
                                        <div style="font-size:12px; margin-bottom:60px">Người in phiếu</div>
                                        <div style="border-top:1px dashed #ccc; padding-top:8px; font-size:11px; color:#666" id="printedByName">—</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Clinical Records (If Completed) -->
                    <div id="clinicalSection" class="info-section" style="display:none">
                        <h4 class="info-title"><span class="material-icons-round">description</span> Kết quả lâm sàng</h4>
                        <div class="bg-primary-light p-4 rounded-xl border border-primary-light">
                            <div class="label-value-group mb-0">
                                <div class="label">Chẩn đoán và lời khuyên từ bác sĩ</div>
                                <div id="clincialNote" class="value text-primary" style="font-size:16px">Đang chờ bác sĩ cập nhật...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex gap-3 mt-4 no-print" id="actionButtons">
                        <button class="btn-primary" onclick="window.print()" style="padding: 10px 24px">
                            <span class="material-icons-round">print</span> In phiếu khám bệnh
                        </button>
                    </div>
                </div>

                <div class="side-panel">
                    <div id="doctorProfile" class="profile-card mb-4" style="display:none">
                        <img id="doctorAvatar" src="" class="profile-avatar" />
                        <h3 class="h5 mb-1" id="doctorName">—</h3>
                        <p class="text-primary font-bold mb-3" id="doctorSpecSide">—</p>
                        <hr class="mb-3"/>
                        <div class="text-start">
                            <div class="label-value-group">
                                <div class="label">Trình độ</div>
                                <div class="value" id="doctorTitle">—</div>
                            </div>
                            <div class="label-value-group">
                                <div class="label">Kinh nghiệm</div>
                                <div class="value" id="doctorExp">—</div>
                            </div>
                        </div>
                        <a id="doctorLink" href="#" class="btn-primary btn-sm w-100">Xem hồ sơ bác sĩ</a>
                    </div>

                    <div id="patientProfile" class="profile-card" style="display:none">
                        <img id="patientAvatar" src="" class="profile-avatar" />
                        <h3 class="h5 mb-1" id="patientName">—</h3>
                        <p class="text-neutral-500 mb-3">Bệnh nhân</p>
                        <hr class="mb-3"/>
                        <div class="text-start">
                            <div class="label-value-group">
                                <div class="label">Email liên hệ</div>
                                <div class="value" id="patientEmail">—</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2026 <strong>MediBook</strong>. Đặt lịch khám bệnh nhanh chóng, quản lý hồ sơ dễ dàng.</p>
        </div>
    </footer>

    <script src="app_v2.js"></script>
    <script>
        let me = null;
        let appt = null;

        (async () => {
            me = await API('/api/auth/me').then(r => r.ok ? r.json() : null).catch(() => null);
            if (!me) { location.href = 'login.html'; return; }
            setNav(me);

            const id = new URLSearchParams(location.search).get('id');
            if (!id) { location.href = 'my-appointments.html'; return; }

            await loadDetail(id);
        })();

        async function loadDetail(id) {
            try {
                const r = await API(`/api/appointments/${id}`);
                if (!r.ok) throw new Error('Không tìm thấy lịch hẹn');
                appt = await r.json();
                renderDetail();
            } catch (err) {
                document.getElementById('loadingState').innerHTML = `
                    <div class="container text-center">
                        <span class="material-icons-round text-danger" style="font-size:48px">error_outline</span>
                        <p class="mt-3 text-neutral-800 font-bold">${err.message}</p>
                        <a href="my-appointments.html" class="btn-primary mt-3" style="text-decoration:none">Quay lại danh sách</a>
                    </div>
                `;
            }
        }

        function renderDetail() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            document.getElementById('pageTitle').innerText = `Chi tiết lịch hẹn #${appt.id.substring(0,8).toUpperCase()}`;
            document.getElementById('apptIdDisplay').innerText = `#${appt.id.substring(0,8).toUpperCase()}`;
            document.getElementById('printedByName').innerText = me.fullName;
            document.getElementById('statusBadgeContainer').innerHTML = statusBadge(appt.status);
            
            const start = new Date(appt.startAt);
            const days = ['Chủ Nhật','Thứ Hai','Thứ Ba','Thứ Tư','Thứ Năm','Thứ Sáu','Thứ Bảy'];
            document.getElementById('apptTimeFull').innerText = `${days[start.getDay()]}, ${fmtDate(appt.startAt)} lúc ${fmtTime(appt.startAt)}`;
            
            document.getElementById('apptNote').innerText = appt.note || 'Không có ghi chú triệu chứng.';
            document.getElementById('apptSpec').innerText = appt.doctorSpecialty || 'Chuyên khoa tổng quát';
            document.getElementById('apptClinic').innerText = appt.clinicName || 'Phòng khám MediBook (Tầng 4, Tòa nhà Y tế)';

            if (appt.status === 'COMPLETED') {
                document.getElementById('clinicalSection').style.display = 'block';
                if (appt.clinicalNote) {
                    document.getElementById('clincialNote').innerText = appt.clinicalNote;
                }
            }

            // Show Doctor or Patient profile based on role
            if (me.role === 'USER') {
                document.getElementById('doctorProfile').style.display = 'block';
                document.getElementById('doctorName').innerText = appt.doctorName;
                document.getElementById('doctorSpecSide').innerText = appt.doctorSpecialty || '';
                document.getElementById('doctorAvatar').src = appt.doctorAvatar || 'https://ui-avatars.com/api/?name='+encodeURIComponent(appt.doctorName);
                if (appt.doctorTitle) document.getElementById('doctorTitle').innerText = appt.doctorTitle;
                if (appt.doctorYearsExperience) document.getElementById('doctorExp').innerText = appt.doctorYearsExperience + ' năm';
                document.getElementById('doctorLink').href = `doctor-details.html?id=${appt.doctorId}`;
                
                // Show cancel button if applicable
                if (['BOOKED', 'CONFIRMED'].includes(appt.status)) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn-danger';
                    cancelBtn.innerHTML = '<span class="material-icons-round">cancel</span> Hủy lịch hẹn';
                    cancelBtn.onclick = () => cancelAppointment(appt.id);
                    document.getElementById('actionButtons').appendChild(cancelBtn);
                }
            } else if (me.role === 'DOCTOR') {
                document.getElementById('breadcrumbParent').innerText = 'Danh sách bệnh nhân';
                document.getElementById('breadcrumbParent').href = 'doctor-patients.html';
                
                document.getElementById('patientProfile').style.display = 'block';
                document.getElementById('patientName').innerText = appt.patientName;
                document.getElementById('patientEmail').innerText = 'Bảo mật';
                document.getElementById('patientAvatar').src = '/assets/default-avatar.svg?v=3';

                // Doctor actions
                if (appt.status === 'BOOKED') {
                    // Confirm button
                    const confirmBtn = document.createElement('button');
                    confirmBtn.className = 'btn-primary';
                    confirmBtn.innerHTML = '<span class="material-icons-round">check_circle</span> Xác nhận lịch khám';
                    confirmBtn.onclick = () => updateStatus('CONFIRMED');
                    document.getElementById('actionButtons').appendChild(confirmBtn);

                    // Reject button
                    const rejectBtn = document.createElement('button');
                    rejectBtn.className = 'btn-danger-outline';
                    rejectBtn.innerHTML = '<span class="material-icons-round">block</span> Từ chối / Hủy';
                    rejectBtn.onclick = () => doctorCancel(appt.id);
                    document.getElementById('actionButtons').appendChild(rejectBtn);

                } else if (appt.status === 'CONFIRMED') {
                    // Complete button
                    const completeBtn = document.createElement('button');
                    completeBtn.className = 'btn-primary';
                    completeBtn.innerHTML = '<span class="material-icons-round">done_all</span> Hoàn thành ca khám';
                    completeBtn.onclick = () => showClinicalModal();
                    document.getElementById('actionButtons').appendChild(completeBtn);

                    // Cancel button for confirmed
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn-danger-outline';
                    cancelBtn.innerHTML = '<span class="material-icons-round">cancel</span> Hủy lịch';
                    cancelBtn.onclick = () => doctorCancel(appt.id);
                    document.getElementById('actionButtons').appendChild(cancelBtn);
                }
            } else if (me.role === 'ADMIN') {
                document.getElementById('breadcrumbParent').innerText = 'Tất cả lịch hẹn';
                document.getElementById('breadcrumbParent').href = 'admin-appointments.html';
                
                // Show both
                document.getElementById('doctorProfile').style.display = 'block';
                document.getElementById('doctorName').innerText = appt.doctorName;
                document.getElementById('doctorSpecSide').innerText = appt.doctorSpecialty || 'Bác sĩ phụ trách';
                document.getElementById('doctorAvatar').src = appt.doctorAvatar || '/assets/default-avatar.svg?v=3';
                if (appt.doctorTitle) document.getElementById('doctorTitle').innerText = appt.doctorTitle;
                if (appt.doctorYearsExperience) document.getElementById('doctorExp').innerText = appt.doctorYearsExperience + ' năm';
                document.getElementById('doctorLink').style.display = 'none';

                document.getElementById('patientProfile').style.display = 'block';
                document.getElementById('patientName').innerText = appt.patientName;
                document.getElementById('patientEmail').innerText = 'Bảo mật (Quyền riêng tư)';
                document.getElementById('patientAvatar').src = '/assets/default-avatar.svg?v=3';
            }
        }

        async function cancelAppointment(id) {
            const confirmed = await showConfirm('Bạn có chắc chắn muốn hủy lịch hẹn này?', { danger: true });
            if (!confirmed) return;
            try {
                const r = await API(`/api/appointments/${id}/cancel`, { method: 'POST' });
                if (!r.ok) throw new Error(await r.text());
                showToast('Đã hủy lịch hẹn', 'success');
                await loadDetail(id);
            } catch (err) { showToast(err.message, 'error'); }
        }

        async function doctorCancel(id) {
            const reason = prompt("Nhập lý do từ chối / hủy lịch (không bắt buộc):");
            if (reason === null) return; // User cancelled prompt
            
            try {
                const r = await API(`/api/appointments/${id}/cancel`, { method: 'POST' });
                if (!r.ok) throw new Error(await r.text());
                showToast('Đã từ chối/hủy lịch hẹn thành công', 'success');
                await loadDetail(id);
            } catch (err) { showToast(err.message, 'error'); }
        }

        async function updateStatus(status) {
            try {
                let endpoint = status === 'CONFIRMED' ? 'confirm' : 'complete';
                const r = await API(`/api/appointments/${appt.id}/${endpoint}`, { method: 'POST' });
                if (!r.ok) throw new Error(await r.text());
                showToast(`Đã cập nhật trạng thái: ${status}`, 'success');
                await loadDetail(appt.id);
            } catch (err) { showToast(err.message, 'error'); }
        }

        function showClinicalModal() {
            // In a real app, this would show a professional modal to input diagnosis
            // For now, we'll use a simple prompt for demo purposes
            const note = prompt("Nhập kết luận / chẩn đoán:");
            if (note === null) return;
            // Assuming endpoint exists for complete with note
            updateStatus('COMPLETED');
        }
    </script>
</body>
</html>
